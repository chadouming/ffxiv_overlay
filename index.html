<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        * {
            font-size: 12px;
        }

        body, html {
            height: 100%;
            margin: 0
        }

        html {
            background-position: bottom right;
            background-repeat: no-repeat;
            box-sizing: border-box;
            background-color: transparent;
        }

        #wrapper {
            background: rgba(0, 0, 0, 0.35);
            box-shadow: 0 0 8px 8px rgba(0, 0, 0, 0.35);
            border-radius: 4px;
            margin: 12px;
            max-height: 554px;
        }

        #combatantTable {
            border-collapse: collapse;
        }

        #combatantTableBody * {
            color: #E2EBF5;
            text-shadow: -1px 0 3px #217AA2, 0 1px 3px #217AA2, 1px 0 3px #217AA2, 0 -1px 3px #217AA2;
            font-weight: 300;
        }
		
        #combatantTableBody tr {
            width: 100%;
            white-space: nowrap;
        }
		
        #combatantTableHeader tr {
	    white-space: nowrap;
        }
		
        ::-webkit-scrollbar {
            width: 0px;  /* remove scrollbar space */
            background: transparent;  /* optional: just make scrollbar invisible */
        }

        #combatantTableBody img {
            height: 20px;
        }
		
        #combatantTableBody .deathImg {
            height: 11px;
            width: 11px;
        }
		
        #combatantTableBody {
            overflow-y: hidden;
            overflow-x: hidden;
        }
		
        #encounter, #combatantTableHeader * {
            color: #DED7BE;
            text-shadow: -1px 0 2px #795516, 0 1px 2px #795516, 1px 0 2px #795516, 0 -1px 2px #795516;
            font-weight: 300;
        }
		
    </style>
    <script>
        var encounterDefine = "Time: {duration} / DPS: {ENCDPS}";
        var useHTMLEncounterDefine = false;

        var headerDefine =
        [
            { text: "#", width: "5vw", align: "center"},
            { text: "Job", width: "5vw", align: "center" },
            { text: "Name", width: "30vw", align: "left" },
            { text: "DPS (%)" , width: "20vw", align: "left" },
            { text: "Crit(%)", width: "15vw", align: "left" },
			{ text: "DH(%) - Crit(%)", width: "20vw", align: "left" },
            { text: "HPS (%)", width: "15vw", align: "left" },
        ];

        var bodyDefine =
        [
            { text: rankingText, width: "5vw", align: "center" },
            { html: "<img src='images/glow-icons-new/{JobOrName}.png' height=100% width=auto onerror='this.src=images/glow-icons-new/error.png'/>", align: "center", width: "5vw"},
            { text: "{name}",  align: "left", width: "27vw", effect: deadAndColorEffect},
            { text: "{encdps} ({damage%})", width: "18vw", align: "left" },
            { text: "{crithit%}", width: "15vw", align: "left" },
			{ text: "{DirectHitPct} - {CritDirectHitPct}", width: "20vw", align: "left" },
            { text: "{enchps} ({healed%})", width: "15vw", align: "left" },
        ];

        function rankingText(combatant, index) {
            return (index + 1).toString();
        }

        function deadAndColorEffect(cell, combatant, index) {
            var deaths = parseInt(combatant["deaths"]);
            if (deaths > 0) {
				cell.innerHTML = cell.innerHTML + " (<img src='images/glow-icons-new/death.png' class='deathImg' /> " + deaths + ")";
            }
			
			if(combatant.JobOrName == "Sam")
				cell.closest('tr').style.backgroundColor = "rgba(175, 120, 23, 0.5)";
			else if(combatant.JobOrName == "Rdm")
				cell.closest('tr').style.backgroundColor = "rgba(140, 0, 26, 0.5)";
			else if(combatant.JobOrName == "Gla" || combatant.JobOrName == "Pld")
				cell.closest('tr').style.backgroundColor = "rgba(168, 210, 230, 0.5)";
			else if(combatant.JobOrName == "Smn" || combatant.JobOrName == "Acn")
				cell.closest('tr').style.backgroundColor = "rgba(45, 155, 120, 0.5)";
			else if(combatant.JobOrName == "War" || combatant.JobOrName == "Mar")
				cell.closest('tr').style.backgroundColor = "rgba(207, 38, 33, 0.5)";
			else if(combatant.JobOrName == "Blm" || combatant.JobOrName == "Thm")
				cell.closest('tr').style.backgroundColor = "rgba(165, 121, 214, 0.5)";
			else if(combatant.JobOrName == "Ast")
				cell.closest('tr').style.backgroundColor = "rgba(255, 231, 74, 0.5)";
			else if(combatant.JobOrName == "Mnk" || combatant.JobOrName == "Pgl")
				cell.closest('tr').style.backgroundColor = "rgba(214, 156, 0, 0.5)";
			else if(combatant.JobOrName == "Sch")
				cell.closest('tr').style.backgroundColor = "rgba(134, 87, 255, 0.5)";
			else if(combatant.JobOrName == "Mch")
				cell.closest('tr').style.backgroundColor = "rgba(110, 225, 214, 0.5)";
			else if(combatant.JobOrName == "Drg" || combatant.JobOrName == "Lnc")
				cell.closest('tr').style.backgroundColor = "rgba(65, 100, 205, 0.5)";
			else if(combatant.JobOrName == "Nin" || combatant.JobOrName == "Rog")
				cell.closest('tr').style.backgroundColor = "rgba(175, 25, 100, 0.5)";
			else if(combatant.JobOrName == "Drk")
				cell.closest('tr').style.backgroundColor = "rgba(209, 38, 204, 0.5)";
			else if(combatant.JobOrName == "Brd" || combatant.JobOrName == "Arc")
				cell.closest('tr').style.backgroundColor = "rgba(145, 186, 94, 0.5)";
			else if(combatant.JobOrName == "Cnj" || combatant.JobOrName == "Whm")
				cell.closest('tr').style.backgroundColor = "rgba(255, 240, 220, 0.5)";
			else
				cell.closest('tr').style.backgroundColor = "rgba(128, 128, 128, 0.5)";
        }

        document.addEventListener("onOverlayDataUpdate", function (e) {
            update(e.detail);
        });
		
        window.addEventListener("message", function (e) {
            if (e.data.type === "onOverlayDataUpdate") {
                update(e.data.detail);
            }
        });

        function update(data) {
            updateEncounter(data);
            if (document.getElementById("combatantTableHeader") == null) {
                updateCombatantListHeader();
            }
            updateCombatantList(data);
        }

        function updateEncounter(data) {
            var encounterElem = document.getElementById('encounter');
            var elementText;
            if (typeof encounterDefine === 'function') {
                elementText = encounterDefine(data.Encounter);
            } else if (typeof encounterDefine === 'string') {
                elementText = parseActFormat(encounterDefine, data.Encounter);
            } else {
                console.log("updateEncounter: Could not update the encounter element due to invalid type.");
                return;
            }

            if (!useHTMLEncounterDefine) {
                encounterElem.innerText = parseActFormat(encounterDefine, data.Encounter);
            } else {
                encounterElem.innerHTML = parseActFormat(encounterDefine, data.Encounter);
            }
        }

        function updateCombatantListHeader() {
            var table = document.getElementById('combatantTable');
            var tableHeader = document.createElement("thead");
            tableHeader.id = "combatantTableHeader";
            var headerRow = tableHeader.insertRow();

            for (var i = 0; i < headerDefine.length; i++) {
                var cell = document.createElement("th");
                if (typeof headerDefine[i].text !== 'undefined') {
                    cell.innerText = headerDefine[i].text;
                } else if (typeof headerDefine[i].html !== 'undefined') {
                    cell.innerHTML = headerDefine[i].html;
                }

                cell.style.width = headerDefine[i].width;
                cell.style.maxWidth = headerDefine[i].width;

                if (typeof headerDefine[i].span !== 'undefined') {
                    cell.colSpan = headerDefine[i].span;
                }
                if (typeof headerDefine[i].align !== 'undefined') {
                    cell.style["textAlign"] = headerDefine[i].align;
                }
                headerRow.appendChild(cell);
            }

            table.tHead = tableHeader;
        }

        function updateCombatantList(data) {
            var table = document.getElementById('combatantTable');
            var oldTableBody = table.tBodies.namedItem('combatantTableBody');
            var newTableBody = document.createElement("tbody");
            newTableBody.id = "combatantTableBody";

            var combatantIndex = 0;
            for (var combatantName in data.Combatant) {
                var combatant = data.Combatant[combatantName];
                combatant.JobOrName = combatant.Job || combatantName;
                var egiSearch = combatant.JobOrName.indexOf("-Egi (");
                if (egiSearch != -1) {
                    combatant.JobOrName = combatant.JobOrName.substring(0, egiSearch);
                }
                else if (combatant.JobOrName.indexOf("Eos (") == 0) {
                    combatant.JobOrName = "Eos";
                }
                else if (combatant.JobOrName.indexOf("Selene (") == 0) {
                    combatant.JobOrName = "Selene";
                }
				else if (combatant.JobOrName.indexOf("Demi-Bahamut (") == 0) {
                    combatant.JobOrName = "Demi-Bahamut";
                }
                else if (combatant.JobOrName.indexOf("Carbuncle (") != -1) {
                    // currently no carbuncle pics
                }
                else if (combatant.JobOrName.indexOf(" (") != -1) {
                    combatant.JobOrName = "choco";
                }

                var tableRow = newTableBody.insertRow(newTableBody.rows.length);
                for (var i = 0; i < bodyDefine.length; i++) {
                    var cell = tableRow.insertCell(i);
                    if (typeof bodyDefine[i].text !== 'undefined') {
                        var cellText;
                        if (typeof bodyDefine[i].text === 'function') {
                            cellText = bodyDefine[i].text(combatant, combatantIndex);
                        } else {
                            cellText = parseActFormat(bodyDefine[i].text, combatant);
                        }
                        cell.innerText = cellText;
                    } else if (typeof bodyDefine[i].html !== 'undefined') {
                        var cellHTML;
                        if (typeof bodyDefine[i].html === 'function') {
                            cellHTML = bodyDefine[i].html(combatant, combatantIndex);
                        } else {
                            cellHTML = parseActFormat(bodyDefine[i].html, combatant);
                        }
                        cell.innerHTML = cellHTML;
                    }

                    cell.style.width = bodyDefine[i].width;
                    cell.style.maxWidth = bodyDefine[i].width;

                    if (typeof (bodyDefine[i].align) !== 'undefined') {
                        cell.style.textAlign = bodyDefine[i].align;
                    }
                    if (typeof bodyDefine[i].effect === 'function') {
                        bodyDefine[i].effect(cell, combatant, combatantIndex);
                    }
                }
                combatantIndex++;
            }

            if (oldTableBody != void (0)) {
                table.replaceChild(newTableBody, oldTableBody);
            }
            else {
                table.appendChild(newTableBody);
            }
        }

        function parseActFormat(str, dictionary) {
            var result = "";

            var currentIndex = 0;
            do {
                var openBraceIndex = str.indexOf('{', currentIndex);
                if (openBraceIndex < 0) {
                    result += str.slice(currentIndex);
                    break;
                }
                else {
                    result += str.slice(currentIndex, openBraceIndex);
                    var closeBraceIndex = str.indexOf('}', openBraceIndex);
                    if (closeBraceIndex < 0) {
                        // parse error!
                        console.log("parseActFormat: Parse error: missing close-brace for " + openBraceIndex.toString() + ".");
                        return "ERROR";
                    }
                    else {
                        var tag = str.slice(openBraceIndex + 1, closeBraceIndex);
                        if (typeof dictionary[tag] !== 'undefined') {
                            result += dictionary[tag];
                        } else {
                            console.log("parseActFormat: Unknown tag: " + tag);
                            result += "ERROR";
                        }
                        currentIndex = closeBraceIndex + 1;
                    }
                }
            } while (currentIndex < str.length);

            return result;
        }

    </script>
</head>
<body onload="">
    <div id="wrapper">
        <div id="encounter">
            No data to show.
        </div>

        <table id="combatantTable">
        </table>
    </div>
</body>
</html>
